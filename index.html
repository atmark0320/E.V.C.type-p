<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E.V.C.type:p</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 10px; background-color: #f9f9f9; }
        .container { margin: 15px 0; }
        h1 { font-size: 1.5em; margin: 0; }
        h2 { font-size: 1.1em; } /* 縮小 */
        h3 { font-size: 1.0em; } /* 縮小 */
        select, button, input[type="number"] { padding: 8px; font-size: 1em; width: 100%; box-sizing: border-box; }
        .probability-table-wrapper { overflow-x: auto; }
        table { border-collapse: collapse; width: 100%; max-width: 400px; }
        th, td { border: 1px solid #ccc; padding: 6px; text-align: center; font-size: 0.9em; }
        .disabled { background-color: #e0e0e0; }
        .error-input { border: 2px solid red; background-color: #ffebee; }
        .prob-input { width: 50px; font-size: 0.9em; padding: 4px; transition: border 0.3s; }
        .car-row-1 { background-color: white; color: black; }
        .car-row-2 { background-color: black; color: white; }
        .car-row-3 { background-color: red; color: white; }
        .car-row-4 { background-color: blue; color: white; }
        .car-row-5 { background-color: yellow; color: black; }
        .car-row-6 { background-color: green; color: white; }
        .car-row-7 { background-color: orange; color: black; }
        .car-row-8 { background-color: pink; color: black; }
        .car-row-9 { background-color: purple; color: white; }
        .button-container { display: flex; gap: 10px; justify-content: space-between; }
        button { margin-top: 10px; background-color: #0288d1; color: white; border: none; cursor: pointer; flex: 1; }
        button:disabled { background-color: #b0bec5; }
        #resetButton { background-color: #d32f2f; }
        #saveButton { background-color: #0288d1; }
        .fill-button { background-color: #ffa726; padding: 4px; font-size: 0.8em; width: 100%; margin: 0; }
        .error { color: #d32f2f; font-weight: bold; margin-top: 10px; }
        .sum-span { font-size: 0.8em; color: #333; margin-left: 5px; }
        .message { font-size: 0.9em; color: #666; }
        .saved-bets { margin-top: 20px; padding: 10px; border: 1px solid #ccc; }
        #errorModal { 
            display: none; 
            position: fixed; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            background: white; 
            padding: 20px; 
            border: 1px solid #ccc; 
            box-shadow: 0 0 10px rgba(0,0,0,0.5); 
            z-index: 1000; 
            max-height: 90vh; 
            overflow-y: auto; 
        }
        #manualOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        #manualModal { 
            display: none; 
            position: fixed; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            background: white; 
            padding: 20px; 
            border: 1px solid #ccc; 
            box-shadow: 0 0 10px rgba(0,0,0,0.5); 
            z-index: 1000; 
            width: 80%; 
            max-width: 500px; 
            max-height: 70vh; 
            overflow-y: auto; 
        }
        .fill-button-cell { padding: 2px; }
        .manual-link { 
            font-size: 0.6em; /* 二段階縮小: 1em → 0.6em */
            color: #0288d1; 
            cursor: pointer; 
            text-decoration: underline; 
            float: right; 
        }
        .results-container { display: flex; flex-wrap: wrap; gap: 20px; }
        .result-section { flex: 1; min-width: 300px; }
        @media (max-width: 600px) {
            th, td { padding: 4px; font-size: 0.8em; }
            .prob-input { width: 40px; }
            .button-container { flex-direction: row; gap: 5px; }
            button { width: 33%; max-width: none; }
            table { max-width: 100%; }
            .sum-span { font-size: 0.7em; }
            .fill-button { font-size: 0.7em; padding: 3px; }
            #errorModal { width: 90%; max-height: 85vh; }
            #manualModal { width: 90%; max-width: 400px; max-height: 65vh; }
            .results-container { flex-direction: column; }
        }
    </style>
</head>
<body>
    <h1>E.V.C.type:p <span class="manual-link" onclick="showManualModal()">マニュアル</span></h1>
    
    <!-- 出走数と着順候補選択エリア -->
    <div class="container">
        <h2>レース設定</h2>
        <table>
            <thead>
                <tr>
                    <th>出走数</th>
                    <th>1着候補</th>
                    <th>2着候補</th>
                    <th>目標回収率(%)</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><select id="carCount" onchange="generateCarInputs()">
                        <option value="">選択してください</option>
                        <option value="5">５</option>
                        <option value="6">６</option>
                        <option value="7">７</option>
                        <option value="8">８</option>
                        <option value="9">９</option>
                    </select></td>
                    <td><select id="firstSelect" onchange="updateProbabilityInputs()"></select></td>
                    <td><select id="secondSelect" onchange="updateProbabilityInputs()"></select></td>
                    <td><input type="number" id="targetRecovery" min="1" max="1000" step="1" value="100"></td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- 確率入力エリア -->
    <div class="container">
        <h2>確率入力</h2>
        <div class="probability-table-wrapper">
            <div id="probabilityInputs"></div>
        </div>
    </div>

    <!-- ボタンエリア -->
    <div class="container">
        <div class="button-container">
            <button onclick="calculateOdds()" disabled id="calcButton">計算する</button>
            <button onclick="saveSelectedBets()" disabled id="saveButton">選択を保存</button>
            <button onclick="resetForm()" id="resetButton">リセット</button>
        </div>
    </div>

    <!-- 結果表示エリア -->
    <div id="results" class="container"></div>

    <!-- 保存された買い目表示エリア -->
    <div class="container">
        <h2>保存された買い目</h2>
        <div id="savedBets" class="saved-bets"></div>
    </div>

    <!-- エラーモーダル -->
    <div id="errorModal">
        <p id="errorMessage" class="error"></p>
        <button onclick="closeModal()">閉じる</button>
    </div>

    <!-- マニュアルオーバーレイ -->
    <div id="manualOverlay" onclick="closeManualModal()"></div>

    <!-- マニュアルモーダル -->
    <div id="manualModal">
        <h2>E.V.C.type:p 操作マニュアル</h2>
        <h3>概要</h3>
        <p>「E.V.C.type:p」は、競輪の二連単および三連単の予想オッズを計算するためのツールです。出走数、1着・2着候補、各枠番の着順確率を入力することで、目標回収率に基づいた必要オッズを計算し、買い目を保存できます。</p>
        
        <h3>基本操作</h3>
        <h4>1. レース設定の入力</h4>
        <ol>
            <li><strong>出走数の選択</strong><br>「出走数」ドロップダウンから「５」「６」「７」「８」「９」のいずれかを選択します。選択後、1着候補と2着候補の選択肢が更新されます。</li>
            <li><strong>1着候補の選択</strong><br>「1着候補」ドロップダウンから予想する1着の枠番（例: 1番）を選択します。選択すると、確率入力欄が表示されます。</li>
            <li><strong>2着候補の選択（任意）</strong><br>「2着候補」ドロップダウンから予想する2着の枠番（例: 2番）を選択します。1着と同じ枠番は選択できません。未選択のままでも計算可能です（この場合、二連単のみ計算）。</li>
            <li><strong>目標回収率の入力</strong><br>「目標回収率(%)」に整数値を入力します（デフォルト: 100）。範囲は1～1000で、小数点以下の入力はできません（例: 100, 95, 105）。</li>
        </ol>

        <h4>2. 確率入力</h4>
        <ol>
            <li><strong>確率表の確認</strong><br>1着候補を選択すると、「確率入力」欄に表が表示されます。枠番ごとに「1着率(%)」「2着率(%)」「3着率(%)」の欄があります。</li>
            <li><strong>確率の入力</strong><br>各枠番の1着率、2着率、3着率を0～100の範囲で整数値を入力します。1着候補の枠番は2着率・3着率が無効（グレーアウト）。2着候補の枠番は3着率が無効。各列の合計は100%になるように調整してください（合計が100を超えるとエラー表示）。</li>
            <li><strong>均等入力ボタンの使用</strong><br>「1着均等入力」「2着均等入力」「3着均等入力」ボタンを押すと、未入力の欄に残りの確率を均等に割り振ります。例: 1着率合計が70の場合、残り30を未入力の枠番で均等に分けます（整数で割り振り）。</li>
        </ol>

        <h4>3. 計算と結果確認</h4>
        <ol>
            <li><strong>計算の実行</strong><br>必要な項目を入力後、「計算する」ボタンを押します。未入力項目がある場合や確率合計が100%でない場合、エラーモーダルが表示されます。</li>
            <li><strong>結果の表示</strong><br><strong>二連単</strong>: 1着候補が選択されている場合、1着固定の組み合わせ（例: 「1-2」「1-3」）が表示されます。<br><strong>三連単</strong>: 1着と2着候補が選択されている場合、1着・2着固定の組み合わせ（例: 「1-2-3」「1-2-4」）が表示されます。<br>各出目には「成立確率」（小数点第1位まで、例: 33.3%）と「必要オッズ」が表示されます。</li>
        </ol>

        <h4>4. 買い目の保存</h4>
        <ol>
            <li><strong>買い目の選択</strong><br>計算結果の表で、保存したい出目のチェックボックスをオンにします。</li>
            <li><strong>保存の実行</strong><br>「選択を保存」ボタンを押すと、選択した買い目が「保存された買い目」欄に追加されます。保存後、計算結果はクリアされ、出走数と目標回収率の変更が無効化されます。</li>
            <li><strong>保存内容の確認</strong><br>「保存された買い目」に買い目数、合成オッズ、詳細（種類、出目、確率（小数点第1位まで）、オッズ）が表示されます。</li>
        </ol>

        <h4>5. リセット</h4>
        <p>「リセット」ボタンを押すと、すべての入力と保存データが初期化されます。出走数、1着・2着候補、確率、目標回収率、計算結果、保存された買い目がクリアされます。</p>

        <h3>注意事項</h3>
        <ul>
            <li><strong>確率の合計</strong>: 1着率、2着率、3着率の各合計が100%でない場合、エラーが表示されます。調整してください。</li>
            <li><strong>入力値の範囲</strong>: 確率は0～100、目標回収率は1～1000の範囲で、整数のみ入力してください。</li>
            <li><strong>モバイル対応</strong>: スマートフォンでも操作可能ですが、表が見づらい場合は横にしてください。</li>
        </ul>

        <h3>操作例</h3>
        <h4>二連単のみ計算する場合</h4>
        <ol>
            <li>出走数: 9</li>
            <li>1着候補: 1番</li>
            <li>確率入力:<br>- 1着率: 1番=30, 2～9番=10（合計100）<br>- 2着率: 2～9番=12または13（合計100）</li>
            <li>目標回収率: 100</li>
            <li>「計算する」を押す</li>
            <li>結果: 「1-2」「1-3」などが表示（例: 成立確率 3.8%）</li>
        </ol>

        <h4>二連単と三連単を計算する場合</h4>
        <ol>
            <li>出走数: 9</li>
            <li>1着候補: 1番、2着候補: 2番</li>
            <li>確率入力:<br>- 1着率: 1番=30, 2～9番=10（合計100）<br>- 2着率: 2番=30, 3～9番=10（合計100）<br>- 3着率: 3～9番=14または15（合計100）</li>
            <li>目標回収率: 95</li>
            <li>「計算する」を押す</li>
            <li>結果:<br>- 二連単: 「1-2」「1-3」など（例: 成立確率 9.0%）<br>- 三連単: 「1-2-3」「1-2-4」など（例: 成立確率 1.3%）</li>
        </ol>

        <h3>トラブルシューティング</h3>
        <ul>
            <li><strong>計算ボタンが押せない</strong>: 出走数と1着候補が選択されているか確認してください。</li>
            <li><strong>エラーモーダルが表示される</strong>: 確率の合計や未入力項目を確認し、修正してください。</li>
            <li><strong>三連単が表示されない</strong>: 2着候補が選択されているか確認してください。</li>
            <li><strong>小数点が入力できない</strong>: 目標回収率は整数のみ入力可能です（仕様）。</li>
        </ul>

        <button onclick="closeManualModal()">閉じる</button>
    </div>

    <script>
        let savedBets = [];
        let probabilities = { win: {}, place: {}, show: {} };

        function generateCarInputs() {
            const count = parseInt(document.getElementById('carCount').value);
            const firstSelect = document.getElementById('firstSelect');
            const secondSelect = document.getElementById('secondSelect');
            firstSelect.innerHTML = '<option value="">選択してください</option>';
            secondSelect.innerHTML = '<option value="">選択してください</option>';
            document.getElementById('probabilityInputs').innerHTML = '';
            document.getElementById('results').innerHTML = '';
            
            if (!count) {
                document.getElementById('calcButton').disabled = true;
                document.getElementById('saveButton').disabled = true;
                return;
            }

            for (let i = 1; i <= count; i++) {
                const option1 = document.createElement('option');
                option1.value = i;
                option1.text = `${i}番`;
                firstSelect.appendChild(option1);
            }
            updateProbabilityInputs();
        }

        function updateProbabilityInputs() {
            const count = parseInt(document.getElementById('carCount').value);
            const firstSelect = document.getElementById('firstSelect');
            const secondSelect = document.getElementById('secondSelect');
            const firstSelected = parseInt(firstSelect.value) || null;
            const secondSelected = parseInt(secondSelect.value) || null;
            const probContainer = document.getElementById('probabilityInputs');

            secondSelect.innerHTML = '<option value="">選択してください</option>';
            for (let i = 1; i <= count; i++) {
                if (i !== firstSelected) {
                    const option2 = document.createElement('option');
                    option2.value = i;
                    option2.text = `${i}番`;
                    secondSelect.appendChild(option2);
                }
            }
            if (secondSelected && secondSelected !== firstSelected) {
                secondSelect.value = secondSelected;
            } else if (secondSelected === firstSelected) {
                secondSelect.value = '';
            }

            if (!count || !firstSelected) {
                probContainer.innerHTML = '<p class="message">1着候補を選択してください。</p>';
                document.getElementById('calcButton').disabled = true;
                document.getElementById('saveButton').disabled = true;
                return;
            }

            probContainer.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>枠番</th>
                            <th>1着率(%)<span class="sum-span" id="winSum">0</span></th>
                            <th>2着率(%)<span class="sum-span" id="placeSum">0</span></th>
                            <th>3着率(%)<span class="sum-span" id="showSum">0</span></th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Array.from({ length: count }, (_, i) => i + 1).map(i => {
                            let firstInput = `<input type="number" id="win${i}" min="0" max="100" step="1" class="prob-input" value="${probabilities.win[i] || ''}" oninput="updateSums(); probabilities.win[${i}] = this.value">`;
                            let secondInput = `<input type="number" id="place${i}" min="0" max="100" step="1" class="prob-input" value="${probabilities.place[i] || ''}" oninput="updateSums(); probabilities.place[${i}] = this.value">`;
                            let thirdInput = `<input type="number" id="show${i}" min="0" max="100" step="1" class="prob-input" value="${probabilities.show[i] || ''}" oninput="updateSums(); probabilities.show[${i}] = this.value">`;

                            if (i === firstSelected) {
                                secondInput = `<input type="number" id="place${i}" min="0" max="100" step="1" disabled class="disabled prob-input">`;
                                thirdInput = `<input type="number" id="show${i}" min="0" max="100" step="1" disabled class="disabled prob-input">`;
                            } else if (i === secondSelected) {
                                thirdInput = `<input type="number" id="show${i}" min="0" max="100" step="1" disabled class="disabled prob-input">`;
                            }

                            return `
                                <tr class="car-row-${i}">
                                    <td>${i}番</td>
                                    <td>${firstInput}</td>
                                    <td>${secondInput}</td>
                                    <td>${thirdInput}</td>
                                </tr>
                            `;
                        }).join('')}
                        <tr>
                            <td class="fill-button-cell"></td>
                            <td class="fill-button-cell"><button class="fill-button" onclick="fillRemaining('win')">1着均等入力</button></td>
                            <td class="fill-button-cell"><button class="fill-button" onclick="fillRemaining('place')">2着均等入力</button></td>
                            <td class="fill-button-cell"><button class="fill-button" onclick="fillRemaining('show')">3着均等入力</button></td>
                        </tr>
                    </tbody>
                </table>
            `;
            document.getElementById('calcButton').disabled = false;
            document.getElementById('saveButton').disabled = true;
            updateSums();
        }

        function updateSums() {
            const count = parseInt(document.getElementById('carCount').value);
            if (!count) return;

            let winSum = 0, placeSum = 0, showSum = 0;
            const tolerance = 0.01;

            for (let i = 1; i <= count; i++) {
                const winInput = document.getElementById(`win${i}`);
                const placeInput = document.getElementById(`place${i}`);
                const showInput = document.getElementById(`show${i}`);

                const win = parseInt(winInput.value) || 0;
                const place = placeInput.disabled ? 0 : parseInt(placeInput.value) || 0;
                const show = showInput.disabled ? 0 : parseInt(showInput.value) || 0;

                winSum += win;
                placeSum += place;
                showSum += show;

                winInput.classList.toggle('error-input', winSum >= 100 + tolerance);
                placeInput.classList.toggle('error-input', placeSum >= 100 + tolerance && !placeInput.disabled);
                showInput.classList.toggle('error-input', showSum >= 100 + tolerance && !showInput.disabled);
            }
            document.getElementById('winSum').textContent = winSum;
            document.getElementById('placeSum').textContent = placeSum;
            document.getElementById('showSum').textContent = showSum;

            if (winSum >= 100 + tolerance || placeSum >= 100 + tolerance || showSum >= 100 + tolerance) {
                showErrorModal('合計確率が100%を超えています。調整してください。');
            } else {
                closeModal();
            }
        }

        function fillRemaining(type) {
            const count = parseInt(document.getElementById('carCount').value);
            if (!count) return;

            let sum = 0;
            let emptyInputs = [];
            for (let i = 1; i <= count; i++) {
                const input = document.getElementById(`${type}${i}`);
                if (input.disabled) continue;
                const value = parseInt(input.value) || 0;
                if (input.value === '') emptyInputs.push(i);
                else sum += value;
            }

            if (sum >= 100) return;

            const remaining = 100 - sum;
            const emptyCount = emptyInputs.length;
            if (emptyCount === 0) return;

            const baseValue = Math.floor(remaining / emptyCount);
            let totalAssigned = 0;

            emptyInputs.forEach((i, index) => {
                const input = document.getElementById(`${type}${i}`);
                let value = baseValue;
                if (index === emptyInputs.length - 1) {
                    value = remaining - totalAssigned;
                }
                input.value = value;
                probabilities[type][i] = input.value;
                totalAssigned += value;
            });

            updateSums();
        }

        function calculateOdds() {
            const count = parseInt(document.getElementById('carCount').value);
            const targetRecovery = parseFloat(document.getElementById('targetRecovery').value) || 100;
            let cars = [];
            let winSum = 0, placeSum = 0, showSum = 0;
            let hasEmptyInput = false;

            for (let i = 1; i <= count; i++) {
                const winInput = document.getElementById(`win${i}`);
                const placeInput = document.getElementById(`place${i}`);
                const showInput = document.getElementById(`show${i}`);
                
                const win = winInput.value === '' ? null : parseInt(winInput.value);
                const place = placeInput.value === '' || placeInput.disabled ? null : parseInt(placeInput.value);
                const show = showInput.value === '' || showInput.disabled ? null : parseInt(showInput.value);

                if (win === null && !winInput.disabled) hasEmptyInput = true;
                if (place === null && !placeInput.disabled) hasEmptyInput = true;
                if (show === null && !showInput.disabled) hasEmptyInput = true;

                cars.push({ 
                    id: i, 
                    win: win !== null ? win / 100 : 0, 
                    place: place !== null ? place / 100 : 0, 
                    show: show !== null ? show / 100 : 0 
                });
                if (win !== null) winSum += win;
                if (place !== null) placeSum += place;
                if (show !== null) showSum += show;
            }

            const resultsDiv = document.getElementById('results');
            if (hasEmptyInput) {
                showErrorModal('未入力の項目があります。すべての有効な欄に入力してください。');
                document.getElementById('saveButton').disabled = true;
                return;
            }

            const tolerance = 0.01;
            if (Math.abs(winSum - 100) > tolerance || Math.abs(placeSum - 100) > tolerance || Math.abs(showSum - 100) > tolerance) {
                showErrorModal(`確率の合計が100%ではありません。\n1着率合計: ${winSum}%, 2着率合計: ${placeSum}%, 3着率合計: ${showSum}%`);
                document.getElementById('saveButton').disabled = true;
                return;
            }

            const firstSelected = parseInt(document.getElementById('firstSelect').value);
            const secondSelected = document.getElementById('secondSelect').value ? parseInt(document.getElementById('secondSelect').value) : null;
            const firstCar = cars[firstSelected - 1];
            const secondCar = secondSelected ? cars[secondSelected - 1] : null;

            let results = { exacta: [], trifecta: [] };

            if (firstSelected) {
                cars.forEach(s => {
                    if (s.id !== firstSelected) {
                        const prob = firstCar.win * s.place;
                        const baseOdds = (1 / prob);
                        const odds = prob > 0 ? (targetRecovery === 100 ? Number(baseOdds.toFixed(1)) : Number((baseOdds * (targetRecovery / 100)).toFixed(1))) : 1000;
                        results.exacta.push({ pattern: `${firstCar.id}-${s.id}`, prob, odds });
                    }
                });
            }

            if (firstSelected && secondSelected && firstSelected !== secondSelected) {
                cars.forEach(t => {
                    if (t.id !== firstSelected && t.id !== secondSelected) {
                        const prob = firstCar.win * secondCar.place * t.show;
                        const baseOdds = (1 / prob);
                        const odds = prob > 0 ? (targetRecovery === 100 ? Number(baseOdds.toFixed(1)) : Number((baseOdds * (targetRecovery / 100)).toFixed(1))) : 1000;
                        results.trifecta.push({ pattern: `${firstCar.id}-${secondCar.id}-${t.id}`, prob, odds });
                    }
                });
            }

            resultsDiv.innerHTML = `
                <h2>計算結果 (目標回収率: ${targetRecovery}%)</h2>
                <div class="results-container">
                    ${Object.entries(results).map(([type, patterns]) => `
                        <div class="result-section">
                            <h3>${getBetTypeName(type)}</h3>
                            ${patterns.length > 0 ? `
                                <div style="overflow-x: auto;">
                                    <table>
                                        <tr><th>選択</th><th>出目</th><th>成立確率</th><th>必要オッズ</th></tr>
                                        ${patterns.map(p => `
                                            <tr>
                                                <td><input type="checkbox" class="bet-checkbox" data-type="${type}" data-pattern="${p.pattern}" data-prob="${p.prob}" data-odds="${p.odds}"></td>
                                                <td>${p.pattern}</td>
                                                <td>${(p.prob * 100).toFixed(1)}%</td>
                                                <td>${p.odds}倍</td>
                                            </tr>
                                        `).join('')}
                                    </table>
                                </div>
                            ` : '<p>該当なし</p>'}
                        </div>
                    `).join('')}
                </div>
            `;
            document.getElementById('saveButton').disabled = false;
        }

        function saveSelectedBets() {
            const checkboxes = document.querySelectorAll('.bet-checkbox:checked');
            if (checkboxes.length === 0) {
                showErrorModal('保存する買い目を選択してください。');
                return;
            }

            let oddsSum = 0;
            const newBets = [];
            checkboxes.forEach(checkbox => {
                const bet = {
                    type: checkbox.dataset.type,
                    pattern: checkbox.dataset.pattern,
                    prob: parseFloat(checkbox.dataset.prob),
                    odds: parseFloat(checkbox.dataset.odds)
                };
                newBets.push(bet);
                oddsSum += 1 / bet.odds;
            });

            savedBets = savedBets.concat(newBets);

            let totalOddsSum = 0;
            savedBets.forEach(bet => {
                totalOddsSum += 1 / bet.odds;
            });
            const combinedOdds = totalOddsSum > 0 ? Math.round((1 / totalOddsSum) * 100) / 100 : 1000;

            updateSavedBetsDisplay(combinedOdds);
            document.getElementById('results').innerHTML = '';
            document.getElementById('saveButton').disabled = true;

            document.getElementById('carCount').disabled = true;
            document.getElementById('targetRecovery').disabled = true;
        }

        function updateSavedBetsDisplay(combinedOdds) {
            const savedBetsDiv = document.getElementById('savedBets');
            if (savedBets.length === 0) {
                savedBetsDiv.innerHTML = '<p>保存された買い目はまだありません。</p>';
                return;
            }

            savedBetsDiv.innerHTML = `
                <p>保存された買い目数: ${savedBets.length}</p>
                <p>合成オッズ: ${combinedOdds}倍</p>
                <table>
                    <tr><th>種類</th><th>出目</th><th>成立確率</th><th>必要オッズ</th></tr>
                    ${savedBets.map(bet => `
                        <tr>
                            <td>${getBetTypeName(bet.type)}</td>
                            <td>${bet.pattern}</td>
                            <td>${(bet.prob * 100).toFixed(1)}%</td>
                            <td>${bet.odds}倍</td>
                        </tr>
                    `).join('')}
                </table>
            `;
        }

        function resetForm() {
            document.getElementById('carCount').value = '';
            document.getElementById('carCount').disabled = false;
            const firstSelect = document.getElementById('firstSelect');
            const secondSelect = document.getElementById('secondSelect');
            firstSelect.innerHTML = '<option value="">選択してください</option>';
            secondSelect.innerHTML = '<option value="">選択してください</option>';
            document.getElementById('targetRecovery').value = '100';
            document.getElementById('targetRecovery').disabled = false;
            document.getElementById('probabilityInputs').innerHTML = '';
            document.getElementById('results').innerHTML = '';
            document.getElementById('calcButton').disabled = true;
            document.getElementById('saveButton').disabled = true;
            savedBets = [];
            probabilities = { win: {}, place: {}, show: {} };
            updateSavedBetsDisplay();
            closeModal();
        }

        function getBetTypeName(type) {
            const names = { exacta: '二連単', trifecta: '三連単' };
            return names[type];
        }

        function showErrorModal(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('errorModal').style.display = 'none';
        }

        function showManualModal() {
            document.getElementById('manualOverlay').style.display = 'block';
            document.getElementById('manualModal').style.display = 'block';
        }

        function closeManualModal() {
            document.getElementById('manualOverlay').style.display = 'none';
            document.getElementById('manualModal').style.display = 'none';
        }
    </script>
</body>
</html>
